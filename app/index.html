<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Case Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="styles/document-types.css">
    <style>
        .prose { max-width: 65ch; }
        .prose h1 { font-size: 2em; font-weight: 700; margin: 0.5em 0; }
        .prose h2 { font-size: 1.5em; font-weight: 600; margin: 0.75em 0 0.5em; }
        .prose h3 { font-size: 1.25em; font-weight: 600; margin: 0.5em 0; }
        .prose p { margin: 0.5em 0; line-height: 1.7; }
        .prose ul, .prose ol { margin: 0.5em 0; padding-left: 1.5em; }
        .prose li { margin: 0.25em 0; }
        .prose strong { font-weight: 600; }
        
        /* Spoiler Protection System Styles */
        .spoiler-warning-banner {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            border: 3px solid #7f1d1d;
            margin: 1rem 0;
            box-shadow: 0 8px 16px rgba(220, 38, 38, 0.3);
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 8px 16px rgba(220, 38, 38, 0.3); }
            50% { box-shadow: 0 8px 24px rgba(220, 38, 38, 0.6); }
        }
        
        .hint-card-locked {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .hint-card-locked:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .hint-card-unlocked {
            background: #d1fae5;
            border: 2px solid #10b981;
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .spoiler-blur {
            filter: blur(20px);
            user-select: none;
            pointer-events: none;
            transition: filter 2s ease-out;
        }
        
        .spoiler-blur.revealed {
            filter: blur(0);
            user-select: auto;
            pointer-events: auto;
        }
        
        .countdown-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: #ef4444;
            animation: countdown-pulse 1s ease-in-out;
        }
        
        @keyframes countdown-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .spoiler-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }
        
        .spoiler-modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: scale(1);
            animation: modalPop 0.3s ease;
        }
        
        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reset-progress-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reset-progress-btn:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }
        
        /* Document Modal & Viewer Animations */
        .document-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .opening-animation {
            animation: openEnvelope 0.6s ease-out;
        }
        
        @keyframes openEnvelope {
            0% { transform: scale(0.8) rotateX(90deg); opacity: 0; }
            50% { transform: scale(1.05) rotateX(0deg); }
            100% { transform: scale(1) rotateX(0deg); opacity: 1; }
        }
        
        .unfold-animation {
            animation: unfoldDocument 0.5s ease-out;
        }
        
        @keyframes unfoldDocument {
            0% { transform: scaleY(0.1); transform-origin: top; opacity: 0; }
            100% { transform: scaleY(1); opacity: 1; }
        }
        
        .doc-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.25rem;
            text-transform: uppercase;
        }
        
        .category-official { border-left: 4px solid #2563eb; }
        .category-correspondence { border-left: 4px solid #16a34a; }
        .category-evidence { border-left: 4px solid #ea580c; }
        .category-hints { border-left: 4px solid #fbbf24; }
        .category-solutions { border-left: 4px solid #dc2626; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Document Types Classification (inlined to avoid module compatibility issues)
        const DOCUMENT_TYPES = {
          'readme': { name: 'Incipit del Caso', icon: 'file', category: 'briefing', spoiler: false },
          'decision-tree': { name: 'Albero Decisionale', icon: 'gitBranch', category: 'solutions', spoiler: true },
          'master-doc': { name: 'Documento Master', icon: 'fileText', category: 'solutions', spoiler: true },
          'instructions': { name: 'Istruzioni Giocatori', icon: 'helpCircle', category: 'briefing', spoiler: false },
          'narration': { name: 'Script Narrazione Finale', icon: 'film', category: 'solutions', spoiler: true },
          'email': { name: 'Email', icon: 'mail', category: 'correspondence', spoiler: false },
          'police': { name: 'Rapporto Polizia', icon: 'shield', category: 'official', spoiler: false },
          'medical': { name: 'Referto Medico', icon: 'heart', category: 'official', spoiler: false },
          'forensic': { name: 'Analisi Forense', icon: 'search', category: 'official', spoiler: false },
          'diary': { name: 'Diario Personale', icon: 'book', category: 'correspondence', spoiler: false },
          'chat': { name: 'Chat/Messaggi', icon: 'message', category: 'correspondence', spoiler: false },
          'bank': { name: 'Estratto Conto', icon: 'dollar', category: 'evidence', spoiler: false },
          'legal': { name: 'Documento Legale', icon: 'gavel', category: 'evidence', spoiler: false },
          'newspaper': { name: 'Articolo Stampa', icon: 'newspaper', category: 'evidence', spoiler: false },
          'phone': { name: 'Tabulato Telefonico', icon: 'phone', category: 'evidence', spoiler: false },
          'social': { name: 'Social Media', icon: 'users', category: 'evidence', spoiler: false },
          'photo': { name: 'Fotografia', icon: 'camera', category: 'evidence', spoiler: false },
          'hint': { name: 'Suggerimento', icon: 'lightbulb', category: 'hints', spoiler: true },
          'solution': { name: 'Soluzione', icon: 'key', category: 'solutions', spoiler: true }
        };

        const CATEGORY_INFO = {
          'briefing': { name: 'Materiale del Caso', icon: 'fileText', order: 1 },
          'official': { name: 'Documenti Ufficiali', icon: 'shield', order: 2 },
          'correspondence': { name: 'Corrispondenza Privata', icon: 'mail', order: 3 },
          'evidence': { name: 'Prove Materiali', icon: 'folder', order: 4 },
          'hints': { name: 'Indizi', icon: 'lightbulb', order: 5 },
          'solutions': { name: 'Soluzione', icon: 'key', order: 6 }
        };
        
        window.DOCUMENT_TYPES = DOCUMENT_TYPES;
        window.CATEGORY_INFO = CATEGORY_INFO;
        console.log('‚úÖ DOCUMENT_TYPES caricato:', window.DOCUMENT_TYPES);
    </script>
    
    <script>
        console.log('‚úÖ Script normale eseguito - PRIMA di Babel');
        console.log('React disponibile:', typeof React);
        console.log('ReactDOM disponibile:', typeof ReactDOM);
        console.log('Babel disponibile:', typeof Babel);
    </script>
    
    <script type="text/babel">
        console.log('üîç Script Babel starting...');
        console.log('React:', typeof React);
        console.log('ReactDOM:', typeof ReactDOM);
        console.log('DOCUMENT_TYPES:', typeof DOCUMENT_TYPES);
        console.log('Root element:', document.getElementById('root'));
        
        const { useState, useEffect } = React;
        const API_URL = '/api';

        // SpoilerTracker - LocalStorage Persistence System
        const SpoilerTracker = {
            getCaseKey: (caseId) => `detective-case-${caseId}`,
            
            isHintUnlocked: (caseId, level) => {
                const data = JSON.parse(localStorage.getItem(SpoilerTracker.getCaseKey(caseId)) || '{}');
                return data.hints?.[level] === true;
            },
            
            unlockHint: (caseId, level) => {
                const key = SpoilerTracker.getCaseKey(caseId);
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                if (!data.hints) data.hints = {};
                data.hints[level] = true;
                data.lastHintUnlockedAt = new Date().toISOString();
                localStorage.setItem(key, JSON.stringify(data));
            },
            
            isSolutionUnlocked: (caseId) => {
                const data = JSON.parse(localStorage.getItem(SpoilerTracker.getCaseKey(caseId)) || '{}');
                return data.solution === true;
            },
            
            unlockSolution: (caseId) => {
                const key = SpoilerTracker.getCaseKey(caseId);
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                data.solution = true;
                data.solutionUnlockedAt = new Date().toISOString();
                localStorage.setItem(key, JSON.stringify(data));
            },
            
            reset: (caseId) => {
                localStorage.removeItem(SpoilerTracker.getCaseKey(caseId));
            },
            
            getProgress: (caseId) => {
                return JSON.parse(localStorage.getItem(SpoilerTracker.getCaseKey(caseId)) || '{}');
            }
        };

        // Icon Component with extended library
        const Icon = ({ type, size = 20, className = "" }) => {
            const iconPaths = {
                home: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z',
                folder: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z',
                file: 'M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z M13 2 13 9 20 9',
                lock: 'M3 11h18v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M7 11V7a5 5 0 0 1 10 0v4',
                unlock: 'M3 11h18v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M7 11V7a5 5 0 0 1 9.9-1',
                alert: 'M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9 12 13 M12 17 12.01 17',
                eye: 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0',
                x: 'M18 6L6 18 M6 6L18 18',
                chevronDown: 'M6 9 12 15 18 9',
                chevronRight: 'M9 18 15 12 9 6',
                mail: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6 12 13 2 6',
                shield: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z',
                heart: 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z',
                search: 'M11 11m-8 0a8 8 0 1 0 16 0a8 8 0 1 0 -16 0 M21 21l-4.35-4.35',
                book: 'M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z',
                message: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z',
                dollar: 'M12 1 12 23 M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6',
                gavel: 'M14 13l-7.5 7.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0-.83-.83-.83-2.17 0-3L11 10 M16 16 22 10 M8 8 14 2 M9 7 17 15 M21 11 13 3',
                newspaper: 'M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2 M18 14h-8 M15 18h-5 M10 6h8v4h-8z',
                phone: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z',
                users: 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0 M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75',
                camera: 'M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 13m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0',
                lightbulb: 'M9 18h6 M10 22h4 M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14',
                key: 'M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4',
                zoom: 'M11 11m-8 0a8 8 0 1 0 16 0a8 8 0 1 0 -16 0 M21 21l-4.35-4.35 M8 11 14 11 M11 8 11 14',
                printer: 'M6 9 6 2 18 2 18 9 M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2 M6 14h12v8H6z',
            };
            
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d={iconPaths[type] || iconPaths.file} />
                </svg>
            );
        };

        // HintConfirmModal - Progressive Unlock Confirmation
        const HintConfirmModal = ({ level, onConfirm, onCancel }) => (
            <div className="spoiler-modal" onClick={onCancel}>
                <div className="spoiler-modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-bold mb-4 text-gray-900">ü§î Sei sicuro di voler aprire questo suggerimento?</h2>
                    <p className="text-gray-700 mb-4">
                        Questo potrebbe ridurre il divertimento dell'investigazione.<br/>
                        Hai esaminato tutti i documenti attentamente?
                    </p>
                    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                        <p className="text-yellow-800 font-semibold">Suggerimento Livello {level}/3</p>
                    </div>
                    <div className="flex gap-3">
                        <button 
                            onClick={onCancel}
                            className="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                        >
                            ‚ùå Annulla
                        </button>
                        <button 
                            onClick={onConfirm}
                            className="flex-1 px-6 py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition-colors"
                        >
                            ‚úì S√¨, sblocca
                        </button>
                    </div>
                </div>
            </div>
        );

        // SolutionPasswordModal - Password Protection Layer
        const SolutionPasswordModal = ({ onConfirm, onCancel }) => {
            const [password, setPassword] = useState('');
            const isCorrect = password === 'SPOILER';
            
            const handleSubmit = () => {
                if (isCorrect) onConfirm();
            };
            
            return (
                <div className="spoiler-modal" onClick={onCancel}>
                    <div className="spoiler-modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-gray-900">üîê Conferma Sblocco Soluzione</h2>
                        <p className="text-gray-700 mb-4">Per procedere, digita la password:</p>
                        <input 
                            type="text"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && isCorrect && handleSubmit()}
                            placeholder="Scrivi: SPOILER"
                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-2 text-center text-xl font-mono focus:border-red-500 focus:outline-none"
                            autoFocus
                        />
                        <p className="text-sm text-gray-500 mb-6 text-center">
                            (Digita tutto in maiuscolo: S-P-O-I-L-E-R)
                        </p>
                        <div className="flex gap-3 mb-4">
                            <button 
                                onClick={onCancel}
                                className="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                            >
                                ‚ùå Annulla
                            </button>
                            <button 
                                onClick={handleSubmit}
                                disabled={!isCorrect}
                                className={`flex-1 px-6 py-3 rounded-lg font-semibold transition-colors ${
                                    isCorrect 
                                        ? 'bg-red-600 text-white hover:bg-red-700 cursor-pointer' 
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                            >
                                ‚úì Conferma
                            </button>
                        </div>
                        <p className="text-xs text-red-600 text-center font-semibold">
                            ‚ö†Ô∏è Questa azione non pu√≤ essere annullata!
                        </p>
                    </div>
                </div>
            );
        };

        // CountdownOverlay - Final Protection Layer
        const CountdownOverlay = ({ onComplete, onAbort }) => {
            const [count, setCount] = useState(10);
            const [canAbort, setCanAbort] = useState(true);
            
            useEffect(() => {
                if (count === 7) setCanAbort(false);
                if (count === 0) {
                    onComplete();
                    return;
                }
                const timer = setTimeout(() => setCount(count - 1), 1000);
                return () => clearTimeout(timer);
            }, [count, onComplete]);
            
            return (
                <div className="countdown-overlay">
                    <h2 className="text-4xl font-bold text-white mb-8">‚è≥ Apertura Soluzione in...</h2>
                    <div className="countdown-number" key={count}>{count}</div>
                    <p className="text-xl text-white mb-8">Ultimo momento per cambiare idea!</p>
                    {canAbort && (
                        <button 
                            onClick={onAbort}
                            className="px-8 py-4 bg-red-600 text-white text-xl font-bold rounded-lg hover:bg-red-700 transition-colors"
                        >
                            üõë ANNULLA
                        </button>
                    )}
                </div>
            );
        };

        // Get icon type from document type
        const getIconForDocType = (docType) => {
            const iconMap = {
                readme: 'file', 'decision-tree': 'gitBranch', 'master-doc': 'fileText',
                instructions: 'helpCircle', narration: 'film',
                email: 'mail', police: 'shield', medical: 'heart', forensic: 'search',
                diary: 'book', chat: 'message', bank: 'dollar', legal: 'gavel',
                newspaper: 'newspaper', phone: 'phone', social: 'users', photo: 'camera',
                hint: 'lightbulb', solution: 'key'
            };
            return iconMap[docType] || 'file';
        };

        // DocumentViewer Component - Enhanced with realistic styling
        const DocumentViewer = ({ content, documentType, filename, onClose }) => {
            const [isZoomed, setIsZoomed] = useState(false);
            
            const handlePrint = () => {
                window.print();
            };
            
            const animationClass = documentType === 'email' || documentType === 'chat' 
                ? 'opening-animation' 
                : 'unfold-animation';
            
            return (
                <div className="document-modal print:static print:bg-white" onClick={onClose}>
                    <div 
                        className={`bg-white rounded-xl shadow-2xl w-full overflow-hidden flex flex-col print:shadow-none print:rounded-none print:max-w-full print:max-h-none ${animationClass} ${isZoomed ? 'max-w-7xl max-h-screen' : 'max-w-4xl max-h-[90vh]'}`}
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Header Controls - HIDE ON PRINT */}
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 print:hidden">
                            <div className="flex items-center gap-3">
                                <Icon type={getIconForDocType(documentType)} size={24} className="text-blue-600" />
                                <div>
                                    <h2 className="text-xl font-bold">{filename}</h2>
                                    {window.DOCUMENT_TYPES && window.DOCUMENT_TYPES[documentType] && (
                                        <span className="doc-badge bg-blue-100 text-blue-800">
                                            {window.DOCUMENT_TYPES[documentType].name}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsZoomed(!isZoomed)} 
                                    className="p-2 hover:bg-gray-200 rounded-lg"
                                    title={isZoomed ? "Riduci" : "Ingrandisci"}
                                >
                                    <Icon type="zoom" size={20} />
                                </button>
                                <button 
                                    onClick={handlePrint} 
                                    className="p-2 hover:bg-gray-200 rounded-lg"
                                    title="Stampa"
                                >
                                    <Icon type="printer" size={20} />
                                </button>
                                <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg">
                                    <Icon type="x" size={24} />
                                </button>
                            </div>
                        </div>
                        
                        {/* Document Content */}
                        <div className="flex-1 overflow-y-auto print:overflow-visible print:flex-none">
                            <div className={`doc-${documentType} p-8`}>
                                <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: content.html }} />
                            </div>
                        </div>
                        
                        {/* Footer Info - HIDE ON PRINT */}
                        <div className="p-3 border-t bg-gray-50 text-xs text-gray-600 text-center print:hidden">
                            Documento riservato - Solo per uso investigativo
                        </div>
                    </div>
                </div>
            );
        };

        const MarkdownViewer = ({ content, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h2 className="text-xl font-bold">{content.filename}</h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg"><Icon type="x" size={24} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-8">
                        <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: content.html }} />
                    </div>
                </div>
            </div>
        );

        // Section Component - Enhanced with Spoiler Protection System
        const Section = ({ 
            title, 
            icon, 
            children, 
            category = 'official', 
            spoiler = false, 
            defaultOpen = true, 
            badge = null,
            caseId = null,
            isHintSection = false
        }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            const [isUnlocked, setIsUnlocked] = useState(!spoiler || (caseId && SpoilerTracker.isSolutionUnlocked(caseId)));
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showCountdown, setShowCountdown] = useState(false);
            const [solutionRevealed, setSolutionRevealed] = useState(false);
            
            useEffect(() => {
                if (spoiler && caseId && SpoilerTracker.isSolutionUnlocked(caseId)) {
                    setIsUnlocked(true);
                    setSolutionRevealed(true);
                }
            }, [spoiler, caseId]);
            
            const categoryColors = {
                briefing: 'bg-indigo-50 hover:bg-indigo-100 text-indigo-900',
                official: 'bg-blue-50 hover:bg-blue-100 text-blue-900',
                correspondence: 'bg-green-50 hover:bg-green-100 text-green-900',
                evidence: 'bg-orange-50 hover:bg-orange-100 text-orange-900',
                hints: 'bg-yellow-50 hover:bg-yellow-100 text-yellow-900',
                solutions: 'bg-red-50 hover:bg-red-100 text-red-900'
            };
            
            const iconColors = {
                briefing: 'text-indigo-600',
                official: 'text-blue-600',
                correspondence: 'text-green-600',
                evidence: 'text-orange-600',
                hints: 'text-yellow-600',
                solutions: 'text-red-600'
            };
            
            const bgColor = spoiler && !isUnlocked ? categoryColors.solutions : categoryColors[category] || categoryColors.official;
            const iconColor = spoiler && !isUnlocked ? iconColors.solutions : iconColors[category] || iconColors.official;
            
            const handleUnlockSolution = () => {
                setShowPasswordModal(true);
            };
            
            const handlePasswordConfirmed = () => {
                setShowPasswordModal(false);
                setShowCountdown(true);
            };
            
            const handleCountdownComplete = () => {
                setShowCountdown(false);
                setIsUnlocked(true);
                setSolutionRevealed(true);
                if (caseId) {
                    SpoilerTracker.unlockSolution(caseId);
                }
            };
            
            const handleAbortCountdown = () => {
                setShowCountdown(false);
            };
            
            return (
                <div className={`border rounded-lg overflow-hidden mb-4 shadow-sm category-${category}`}>
                    {showPasswordModal && (
                        <SolutionPasswordModal 
                            onConfirm={handlePasswordConfirmed}
                            onCancel={() => setShowPasswordModal(false)}
                        />
                    )}
                    {showCountdown && (
                        <CountdownOverlay 
                            onComplete={handleCountdownComplete}
                            onAbort={handleAbortCountdown}
                        />
                    )}
                    
                    <div onClick={() => setIsOpen(!isOpen)} className={`p-4 cursor-pointer flex items-center justify-between ${bgColor}`}>
                        <div className="flex items-center gap-3">
                            <Icon type={icon} className={iconColor} size={20} />
                            <h3 className="font-semibold">{title}</h3>
                            {badge && <span className={`doc-badge ${badge.color}`}>{badge.text}</span>}
                            {spoiler && !isUnlocked && <span className="px-2 py-1 bg-red-600 text-white text-xs rounded-full font-semibold">‚ö†Ô∏è SPOILER</span>}
                        </div>
                        <Icon type={isOpen ? 'chevronDown' : 'chevronRight'} size={20} />
                    </div>
                    {isOpen && (
                        <div className="p-4 bg-white">
                            {spoiler && !isUnlocked ? (
                                <div className="spoiler-warning-banner">
                                    <div className="text-center">
                                        <h3 className="text-3xl font-bold mb-4">‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ATTENZIONE SPOILER TOTALE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è</h3>
                                        <p className="text-lg mb-4">
                                            Questa sezione contiene la <strong>SOLUZIONE COMPLETA</strong> del caso.<br/>
                                            Aprirla roviner√† completamente l'esperienza investigativa!
                                        </p>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4 mb-6 text-left">
                                            <p className="font-semibold mb-2">Apri solo se:</p>
                                            <ul className="space-y-1">
                                                <li>‚úì Hai esaminato tutti i documenti</li>
                                                <li>‚úì Hai tentato di risolvere il caso</li>
                                                <li>‚úì Sei completamente bloccato</li>
                                            </ul>
                                        </div>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); handleUnlockSolution(); }} 
                                            className="px-8 py-4 bg-white text-red-600 rounded-lg font-bold hover:bg-gray-100 inline-flex items-center gap-2 text-lg shadow-lg"
                                        >
                                            <Icon type="lock" size={24} />
                                            üîí Sblocca Soluzione
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className={spoiler && !solutionRevealed ? 'spoiler-blur' : ''} 
                                     style={spoiler && !solutionRevealed ? { transition: 'filter 2s ease-out' } : {}}>
                                    {children}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Enhanced FileItem Component with Document Type metadata
        const FileItem = ({ document, caseId, onView }) => {
            const [loading, setLoading] = useState(false);
            
            const handleClick = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/cases/${caseId}/file/${document.type}/${document.filename}`);
                    if (!res.ok) throw new Error('File non trovato');
                    const fileData = await res.json();
                    onView({ ...fileData, documentType: document.type });
                } catch (e) { 
                    alert('Errore caricamento file'); 
                } finally { 
                    setLoading(false); 
                }
            };
            
            const docIcon = getIconForDocType(document.type);
            const isHint = document.type === 'hint';
            const isSolution = document.type === 'solution';
            
            // Extract display name
            const displayName = document.filename
                .replace('.md', '')
                .replace(/^[^_]+_/, '') // Remove type prefix
                .replace(/-/g, ' ')
                .replace(/livello(\d+)/i, 'Livello $1');
            
            const badgeColors = {
                readme: 'bg-indigo-100 text-indigo-800',
                'decision-tree': 'bg-amber-100 text-amber-800',
                'master-doc': 'bg-red-100 text-red-800',
                instructions: 'bg-sky-100 text-sky-800',
                narration: 'bg-purple-100 text-purple-800',
                email: 'bg-green-100 text-green-800',
                police: 'bg-blue-100 text-blue-800',
                medical: 'bg-red-100 text-red-800',
                forensic: 'bg-purple-100 text-purple-800',
                diary: 'bg-amber-100 text-amber-800',
                chat: 'bg-cyan-100 text-cyan-800',
                bank: 'bg-emerald-100 text-emerald-800',
                legal: 'bg-indigo-100 text-indigo-800',
                newspaper: 'bg-gray-100 text-gray-800',
                phone: 'bg-teal-100 text-teal-800',
                social: 'bg-pink-100 text-pink-800',
                photo: 'bg-violet-100 text-violet-800',
                hint: 'bg-yellow-100 text-yellow-800',
                solution: 'bg-red-100 text-red-800'
            };
            
            return (
                <div 
                    onClick={handleClick} 
                    className={`flex items-center gap-3 p-3 hover:bg-blue-50 rounded-lg cursor-pointer group transition-all ${loading ? 'opacity-50' : ''} ${isSolution ? 'border-2 border-red-200' : ''}`}
                >
                    <Icon type={docIcon} className="text-blue-500 group-hover:text-blue-700" size={20} />
                    <span className="flex-1 capitalize">{loading ? 'Caricamento...' : displayName}</span>
                    <div className="flex items-center gap-2">
                        {window.DOCUMENT_TYPES && window.DOCUMENT_TYPES[document.type] && (
                            <span className={`doc-badge ${badgeColors[document.type] || 'bg-gray-100 text-gray-800'}`}>
                                {window.DOCUMENT_TYPES[document.type].name}
                            </span>
                        )}
                        {isHint && document.level && (
                            <span className="doc-badge bg-yellow-200 text-yellow-900 font-bold">
                                #{document.level}
                            </span>
                        )}
                        {isSolution && (
                            <span className="doc-badge bg-red-600 text-white font-bold">
                                SPOILER
                            </span>
                        )}
                        <Icon type="eye" className="text-gray-400 opacity-0 group-hover:opacity-100" size={16} />
                    </div>
                </div>
            );
        };

        // HintItem Component - Progressive Unlock with Confirmation Modal
        const HintItem = ({ document, caseId, onView }) => {
            const [loading, setLoading] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            
            // Extract hint level from filename
            const hintLevel = document.level || 1;
            const isUnlocked = SpoilerTracker.isHintUnlocked(caseId, hintLevel);
            
            const handleClick = async () => {
                if (!isUnlocked) {
                    setShowConfirmModal(true);
                    return;
                }
                
                // If already unlocked, open directly
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/cases/${caseId}/file/${document.type}/${document.filename}`);
                    if (!res.ok) throw new Error('File non trovato');
                    const fileData = await res.json();
                    onView({ ...fileData, documentType: document.type });
                } catch (e) { 
                    alert('Errore caricamento file'); 
                } finally { 
                    setLoading(false); 
                }
            };
            
            const handleConfirmUnlock = async () => {
                setShowConfirmModal(false);
                SpoilerTracker.unlockHint(caseId, hintLevel);
                
                // Load the hint
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/cases/${caseId}/file/${document.type}/${document.filename}`);
                    if (!res.ok) throw new Error('File non trovato');
                    const fileData = await res.json();
                    onView({ ...fileData, documentType: document.type });
                } catch (e) { 
                    alert('Errore caricamento file'); 
                } finally { 
                    setLoading(false); 
                }
            };
            
            const displayName = document.filename
                .replace('.md', '')
                .replace(/^[^_]+_/, '')
                .replace(/-/g, ' ')
                .replace(/livello(\d+)/i, 'Livello $1');
            
            return (
                <>
                    {showConfirmModal && (
                        <HintConfirmModal 
                            level={hintLevel}
                            onConfirm={handleConfirmUnlock}
                            onCancel={() => setShowConfirmModal(false)}
                        />
                    )}
                    <div 
                        onClick={handleClick}
                        className={`${isUnlocked ? 'hint-card-unlocked' : 'hint-card-locked'} ${loading ? 'opacity-50' : ''}`}
                    >
                        <div className="flex items-center gap-3">
                            <Icon 
                                type={isUnlocked ? 'unlock' : 'lock'} 
                                className={isUnlocked ? 'text-green-600' : 'text-yellow-600'} 
                                size={24} 
                            />
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-semibold capitalize">{displayName}</span>
                                    <span className={`doc-badge font-bold ${isUnlocked ? 'bg-green-200 text-green-900' : 'bg-yellow-200 text-yellow-900'}`}>
                                        Livello {hintLevel}/3
                                    </span>
                                </div>
                                {!isUnlocked && (
                                    <div className="flex items-center gap-2 text-sm">
                                        <span className="px-2 py-1 bg-yellow-600 text-white rounded text-xs font-semibold">
                                            ‚ö†Ô∏è SPOILER - Clicca solo se sei bloccato!
                                        </span>
                                    </div>
                                )}
                                {isUnlocked && (
                                    <span className="text-sm text-green-700 font-semibold">‚úÖ SBLOCCATO</span>
                                )}
                            </div>
                            <Icon 
                                type={isUnlocked ? 'eye' : 'alert'} 
                                className={isUnlocked ? 'text-green-600' : 'text-yellow-600'} 
                                size={20} 
                            />
                        </div>
                    </div>
                </>
            );
        };

        // SolutionItem Component - Documents requiring solution unlock
        const SolutionItem = ({ document, caseId, onView }) => {
            const [loading, setLoading] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showCountdown, setShowCountdown] = useState(false);
            const [isUnlocked, setIsUnlocked] = useState(false);
            
            useEffect(() => {
                setIsUnlocked(SpoilerTracker.isSolutionUnlocked(caseId));
            }, [caseId]);
            
            const handleClick = async () => {
                if (!isUnlocked) {
                    setShowPasswordModal(true);
                    return;
                }
                
                // If already unlocked, open directly
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/cases/${caseId}/file/${document.type}/${document.filename}`);
                    if (!res.ok) throw new Error('File non trovato');
                    const fileData = await res.json();
                    onView({ ...fileData, documentType: document.type });
                } catch (e) { 
                    alert('Errore caricamento file'); 
                } finally { 
                    setLoading(false); 
                }
            };
            
            const handlePasswordConfirmed = () => {
                setShowPasswordModal(false);
                setShowCountdown(true);
            };
            
            const handleCountdownComplete = async () => {
                setShowCountdown(false);
                SpoilerTracker.unlockSolution(caseId);
                setIsUnlocked(true);
                
                // Load the document
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/cases/${caseId}/file/${document.type}/${document.filename}`);
                    if (!res.ok) throw new Error('File non trovato');
                    const fileData = await res.json();
                    onView({ ...fileData, documentType: document.type });
                } catch (e) { 
                    alert('Errore caricamento file'); 
                } finally { 
                    setLoading(false); 
                }
            };
            
            const handleAbortCountdown = () => {
                setShowCountdown(false);
            };
            
            const displayName = document.filename
                .replace('.md', '')
                .replace(/^[^_]+_/, '')
                .replace(/-/g, ' ')
                .replace(/albero decisionale/i, 'Albero Decisionale')
                .replace(/documento master/i, 'Documento Master')
                .replace(/script narrazione finale/i, 'Script Narrazione Finale');
            
            return (
                <>
                    {showPasswordModal && (
                        <SolutionPasswordModal 
                            onConfirm={handlePasswordConfirmed}
                            onCancel={() => setShowPasswordModal(false)}
                        />
                    )}
                    {showCountdown && (
                        <CountdownOverlay 
                            onComplete={handleCountdownComplete}
                            onAbort={handleAbortCountdown}
                        />
                    )}
                    <div 
                        onClick={handleClick}
                        className={`${isUnlocked ? 'hint-card-unlocked' : 'hint-card-locked'} ${loading ? 'opacity-50' : ''}`}
                        style={{
                            background: isUnlocked ? '#fee2e2' : '#fef2f2',
                            borderColor: isUnlocked ? '#b91c1c' : '#dc2626'
                        }}
                    >
                        <div className="flex items-center gap-3">
                            <Icon 
                                type={isUnlocked ? 'unlock' : 'lock'} 
                                className={isUnlocked ? 'text-green-600' : 'text-red-600'} 
                                size={24} 
                            />
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-semibold capitalize">{displayName}</span>
                                </div>
                                {!isUnlocked && (
                                    <div className="flex items-center gap-2 text-sm">
                                        <span className="px-2 py-1 bg-red-600 text-white rounded text-xs font-semibold">
                                            ‚ö†Ô∏è SPOILER TOTALE - Richiede password
                                        </span>
                                    </div>
                                )}
                                {isUnlocked && (
                                    <span className="text-sm text-green-700 font-semibold">‚úÖ SBLOCCATO</span>
                                )}
                            </div>
                            <Icon 
                                type={isUnlocked ? 'eye' : 'alert'} 
                                className={isUnlocked ? 'text-green-600' : 'text-red-600'} 
                                size={20} 
                            />
                        </div>
                    </div>
                </>
            );
        };

        // PrintSelectionModal - Modal per selezionare documenti da stampare
        const PrintSelectionModal = ({ caseData, caseId, onClose, onPrint }) => {
            const [selectedDocs, setSelectedDocs] = useState({});
            const [selectAll, setSelectAll] = useState(true);
            
            useEffect(() => {
                // Inizializza tutti i documenti come selezionati
                const allDocs = {};
                if (caseData.documentsByType) {
                    Object.entries(caseData.documentsByType).forEach(([type, docs]) => {
                        docs.forEach(doc => {
                            allDocs[`${type}_${doc.filename}`] = true;
                        });
                    });
                }
                setSelectedDocs(allDocs);
            }, [caseData]);
            
            const handleToggleDoc = (type, filename) => {
                const key = `${type}_${filename}`;
                setSelectedDocs(prev => ({ ...prev, [key]: !prev[key] }));
            };
            
            const handleToggleAll = () => {
                const newVal = !selectAll;
                setSelectAll(newVal);
                const newDocs = {};
                Object.keys(selectedDocs).forEach(key => {
                    newDocs[key] = newVal;
                });
                setSelectedDocs(newDocs);
            };
            
            const selectedCount = Object.values(selectedDocs).filter(v => v).length;
            
            const handlePrint = () => {
                const docsToPreviewAndPrint = [];
                if (caseData.documentsByType) {
                    Object.entries(caseData.documentsByType).forEach(([type, docs]) => {
                        docs.forEach(doc => {
                            if (selectedDocs[`${type}_${doc.filename}`]) {
                                docsToPreviewAndPrint.push({ type, filename: doc.filename });
                            }
                        });
                    });
                }
                onPrint(docsToPreviewAndPrint);
            };
            
            return (
                <div className="spoiler-modal" onClick={onClose}>
                    <div className="spoiler-modal-content" style={{ maxWidth: '700px', maxHeight: '80vh', overflow: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        <div className="mb-4">
                            <h2 className="text-2xl font-bold mb-2 text-gray-900 flex items-center gap-2">
                                <Icon type="printer" size={28} />
                                Stampa Documenti
                            </h2>
                            <p className="text-gray-600">Seleziona i documenti da stampare. Tra ogni documento verr√† inserita un'interruzione di pagina.</p>
                        </div>
                        
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                            <label className="flex items-center gap-2 font-semibold text-blue-900 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    checked={selectAll}
                                    onChange={handleToggleAll}
                                    className="w-5 h-5 cursor-pointer"
                                />
                                Seleziona/Deseleziona Tutti ({selectedCount} selezionati)
                            </label>
                        </div>
                        
                        <div className="space-y-3 mb-6" style={{ maxHeight: '400px', overflowY: 'auto' }}>
                            {caseData.documentsByType && Object.entries(caseData.documentsByType).map(([type, docs]) => {
                                const typeInfo = window.DOCUMENT_TYPES?.[type];
                                if (!typeInfo) return null;
                                
                                return (
                                    <div key={type} className="border rounded-lg p-3 bg-gray-50">
                                        <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                            <Icon type={getIconForDocType(type)} size={16} />
                                            {typeInfo.name} ({docs.length})
                                        </h4>
                                        <div className="pl-4 space-y-1">
                                            {docs.map(doc => {
                                                const key = `${type}_${doc.filename}`;
                                                const displayName = doc.filename
                                                    .replace('.md', '')
                                                    .replace(/^[^_]+_/, '')
                                                    .replace(/-/g, ' ');
                                                
                                                return (
                                                    <label key={key} className="flex items-center gap-2 cursor-pointer hover:bg-white p-2 rounded">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={selectedDocs[key] || false}
                                                            onChange={() => handleToggleDoc(type, doc.filename)}
                                                            className="w-4 h-4 cursor-pointer"
                                                        />
                                                        <span className="text-sm text-gray-700 capitalize">{displayName}</span>
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="flex gap-3">
                            <button 
                                onClick={onClose}
                                className="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                            >
                                ‚ùå Annulla
                            </button>
                            <button 
                                onClick={handlePrint}
                                disabled={selectedCount === 0}
                                className={`flex-1 px-6 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                    selectedCount > 0
                                        ? 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer' 
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                            >
                                <Icon type="printer" size={20} />
                                Stampa {selectedCount} {selectedCount === 1 ? 'documento' : 'documenti'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // CaseView Component - Refactored for documentsByType structure
        const CaseView = ({ caseId, onBack }) => {
            const [caseData, setCaseData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [viewingFile, setViewingFile] = useState(null);
            const [showPrintModal, setShowPrintModal] = useState(false);

            useEffect(() => {
                fetch(`${API_URL}/cases/${caseId}`)
                    .then(r => r.json())
                    .then(setCaseData)
                    .catch(() => alert('Errore caricamento caso'))
                    .finally(() => setLoading(false));
            }, [caseId]);

            if (loading) return (
                <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
                </div>
            );
            
            if (!caseData) return (
                <div className="min-h-screen flex items-center justify-center">
                    <button onClick={onBack} className="px-6 py-2 bg-blue-600 text-white rounded-lg">Torna ai Casi</button>
                </div>
            );

            // Funzione per stampare i documenti selezionati
            const handlePrintDocuments = async (docsToPreview) => {
                if (docsToPreview.length === 0) {
                    alert('Nessun documento selezionato');
                    return;
                }
                
                setShowPrintModal(false);
                
                // Mostra un loader
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'print-loading';
                loadingDiv.innerHTML = `
                    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-center; z-index: 99999;">
                        <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                            <div style="margin-bottom: 1rem;">Caricamento documenti...</div>
                            <div style="animation: spin 1s linear infinite; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loadingDiv);
                
                try {
                    // Carica tutti i documenti
                    const loadedDocs = [];
                    for (const doc of docsToPreview) {
                        const res = await fetch(`${API_URL}/cases/${caseId}/file/${doc.type}/${doc.filename}`);
                        if (res.ok) {
                            const fileData = await res.json();
                            loadedDocs.push({ ...fileData, documentType: doc.type });
                        }
                    }
                    
                    // Rimuovi loader
                    document.body.removeChild(loadingDiv);
                    
                    // Crea un container per la stampa
                    const printContainer = document.createElement('div');
                    printContainer.className = 'print-container';
                    printContainer.style.display = 'none';
                    
                    // Aggiungi tutti i documenti con la struttura completa
                    loadedDocs.forEach((doc, index) => {
                        const docDiv = document.createElement('div');
                        docDiv.className = 'print-document-item';
                        docDiv.innerHTML = `
                            <div class="doc-${doc.documentType || 'unknown'} p-8">
                                <div class="prose max-w-none">
                                    ${doc.html}
                                </div>
                            </div>
                        `;
                        printContainer.appendChild(docDiv);
                    });
                    
                    document.body.appendChild(printContainer);
                    
                    // Aggiungi classe al body per nascondere tutto
                    document.body.classList.add('printing-mode');
                    printContainer.style.display = 'block';
                    
                    // Stampa
                    setTimeout(() => {
                        window.print();
                        
                        // Cleanup dopo la stampa
                        setTimeout(() => {
                            document.body.classList.remove('printing-mode');
                            document.body.removeChild(printContainer);
                        }, 500);
                    }, 500);
                    
                } catch (error) {
                    console.error('Errore durante il caricamento dei documenti:', error);
                    alert('Errore durante il caricamento dei documenti');
                    if (document.getElementById('print-loading')) {
                        document.body.removeChild(loadingDiv);
                    }
                }
            };

            // Group documents by category
            const documentsByCategory = {};
            
            // Check if new structure exists
            if (caseData.documentsByType) {
                Object.entries(caseData.documentsByType).forEach(([type, docs]) => {
                    if (docs && docs.length > 0) {
                        const docTypeInfo = window.DOCUMENT_TYPES?.[type];
                        if (docTypeInfo) {
                            const category = docTypeInfo.category;
                            if (!documentsByCategory[category]) {
                                documentsByCategory[category] = {};
                            }
                            documentsByCategory[category][type] = docs;
                        }
                    }
                });
            }

            // Get sorted categories
            const sortedCategories = Object.keys(documentsByCategory).sort((a, b) => {
                const orderA = window.CATEGORY_INFO?.[a]?.order || 999;
                const orderB = window.CATEGORY_INFO?.[b]?.order || 999;
                return orderA - orderB;
            });

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 print:bg-white">
                    {showPrintModal && (
                        <PrintSelectionModal 
                            caseData={caseData}
                            caseId={caseId}
                            onClose={() => setShowPrintModal(false)}
                            onPrint={handlePrintDocuments}
                        />
                    )}
                    
                    {viewingFile && (
                        <DocumentViewer 
                            content={viewingFile} 
                            documentType={viewingFile.documentType || 'unknown'}
                            filename={viewingFile.filename}
                            onClose={() => setViewingFile(null)} 
                        />
                    )}
                    
                    <div className="max-w-5xl mx-auto p-6 print:hidden">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium">
                                <Icon type="home" size={20} />Torna ai Casi
                            </button>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setShowPrintModal(true)}
                                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md"
                                >
                                    <Icon type="printer" size={20} />
                                    Stampa Documenti
                                </button>
                                <button 
                                    onClick={() => {
                                        if (confirm('Sei sicuro di voler resettare tutti gli spoiler sbloccati? Dovrai risbloccare hints e soluzioni.')) {
                                            SpoilerTracker.reset(caseId);
                                            window.location.reload();
                                        }
                                    }}
                                    className="reset-progress-btn"
                                >
                                    üîÑ Reset Spoiler
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
                            <h1 className="text-4xl font-bold mb-2">{caseData.title}</h1>
                            <p className="text-gray-600">Naviga tra i documenti per tipo e risolvi il mistero</p>
                        </div>

                        {/* Instructions Section */}
                        {caseData.files?.istruzioni?.length > 0 && (
                            <Section title="üìã Istruzioni e Guida" icon="file" category="official">
                                {caseData.files.istruzioni.map(f => (
                                    <FileItem 
                                        key={f} 
                                        document={{ filename: f, type: 'instruction' }}
                                        caseId={caseId} 
                                        onView={setViewingFile}
                                    />
                                ))}
                            </Section>
                        )}

                        {/* Document Categories */}
                        {sortedCategories.map(category => {
                            const categoryInfo = window.CATEGORY_INFO?.[category];
                            if (!categoryInfo) return null;

                            const categoryTypes = documentsByCategory[category];
                            const totalDocs = Object.values(categoryTypes).reduce((sum, docs) => sum + docs.length, 0);
                            
                            // Category icons
                            const categoryIcons = {
                                briefing: 'fileText',
                                official: 'shield',
                                correspondence: 'mail',
                                evidence: 'folder',
                                hints: 'lightbulb',
                                solutions: 'key'
                            };

                            // Special handling for hints and solutions
                            const isSpoilerCategory = category === 'hints' || category === 'solutions';
                            const defaultOpen = category !== 'hints' && category !== 'solutions';

                            return (
                                <Section
                                    key={category}
                                    title={`${categoryInfo.name} (${totalDocs})`}
                                    icon={categoryIcons[category] || 'folder'}
                                    category={category}
                                    spoiler={false}
                                    defaultOpen={defaultOpen}
                                    caseId={caseId}
                                    badge={category === 'hints' ? { text: '‚ö†Ô∏è ATTENZIONE', color: 'bg-yellow-200 text-yellow-900' } : 
                                           category === 'solutions' ? { text: 'üîí SPOILER', color: 'bg-red-200 text-red-900' } : null}
                                >
                                    {/* Group by document type within category */}
                                    {Object.entries(categoryTypes).map(([type, docs]) => {
                                        const typeInfo = window.DOCUMENT_TYPES?.[type];
                                        if (!typeInfo) return null;

                                        const isHintType = type === 'hint';
                                        const isSolutionType = category === 'solutions' && typeInfo.spoiler;

                                        return (
                                            <div key={type} className="mb-4">
                                                <h4 className="text-sm font-semibold text-gray-600 mb-2 flex items-center gap-2">
                                                    <Icon type={getIconForDocType(type)} size={16} />
                                                    {typeInfo.name} ({docs.length})
                                                </h4>
                                                <div className={`pl-4 border-l-2 border-gray-200 ${(isHintType || isSolutionType) ? 'space-y-3' : 'space-y-1'}`}>
                                                    {docs.map((doc, idx) => (
                                                        isHintType ? (
                                                            <HintItem
                                                                key={doc.filename || idx}
                                                                document={doc}
                                                                caseId={caseId}
                                                                onView={setViewingFile}
                                                            />
                                                        ) : isSolutionType ? (
                                                            <SolutionItem
                                                                key={doc.filename || idx}
                                                                document={doc}
                                                                caseId={caseId}
                                                                onView={setViewingFile}
                                                            />
                                                        ) : (
                                                            <FileItem
                                                                key={doc.filename || idx}
                                                                document={doc}
                                                                caseId={caseId}
                                                                onView={setViewingFile}
                                                            />
                                                        )
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {/* Warning message for hints */}
                                    {category === 'hints' && (
                                        <div className="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                            <p className="text-sm text-yellow-800">
                                                üí° <strong>Suggerimenti progressivi:</strong> Usa questi indizi solo se sei bloccato. Leggi dal livello pi√π basso al pi√π alto per evitare spoiler eccessivi.
                                            </p>
                                        </div>
                                    )}
                                </Section>
                            );
                        })}

                        {/* Fallback to old structure if documentsByType not available */}
                        {!caseData.documentsByType && (
                            <>
                                {caseData.files?.investigativi?.length > 0 && (
                                    <Section title="üîç Documenti Investigativi" icon="folder" category="official">
                                        {caseData.files.investigativi.map(f => (
                                            <FileItem key={f} document={{ filename: f, type: 'unknown' }} caseId={caseId} onView={setViewingFile} />
                                        ))}
                                    </Section>
                                )}
                                {caseData.files?.prove?.length > 0 && (
                                    <Section title="üìÑ Prove Documentali" icon="file" category="evidence">
                                        {caseData.files.prove.map(f => (
                                            <FileItem key={f} document={{ filename: f, type: 'unknown' }} caseId={caseId} onView={setViewingFile} />
                                        ))}
                                    </Section>
                                )}
                                {caseData.files?.digitali?.length > 0 && (
                                    <Section title="üíæ Elementi Digitali" icon="folder" category="correspondence">
                                        {caseData.files.digitali.map(f => (
                                            <FileItem key={f} document={{ filename: f, type: 'unknown' }} caseId={caseId} onView={setViewingFile} />
                                        ))}
                                    </Section>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const CaseSelector = ({ onSelectCase }) => {
            const [cases, setCases] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetch(`${API_URL}/cases`)
                    .then(r => r.json())
                    .then(setCases)
                    .catch(() => setError('Server non raggiungibile'))
                    .finally(() => setLoading(false));
            }, []);

            if (loading) return <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center"><div className="animate-spin h-16 w-16 border-b-2 border-white rounded-full"></div></div>;
            if (error) return (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center p-6">
                    <div className="bg-white rounded-xl p-8 max-w-2xl text-center">
                        <h1 className="text-3xl font-bold text-red-600 mb-4">‚ö†Ô∏è Errore</h1>
                        <p className="mb-4">Server non raggiungibile. Avvia il server con:</p>
                        <code className="bg-gray-100 px-3 py-2 rounded block">npm start</code>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900">
                    <div className="max-w-6xl mx-auto p-6 pt-12">
                        <div className="text-center mb-12">
                            <h1 className="text-6xl font-bold text-white mb-4">üîç Detective Case Files</h1>
                            <p className="text-xl text-blue-200">Seleziona un caso da investigare</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {cases.map(c => (
                                <div key={c.id} onClick={() => onSelectCase(c.id)} className="bg-white rounded-xl shadow-xl overflow-hidden cursor-pointer hover:scale-105 transition-transform group">
                                    <div className="h-40 bg-gradient-to-br from-blue-500 to-purple-600 relative">
                                        <div className="absolute bottom-4 left-4 right-4">
                                            <div className="bg-white/90 rounded-lg p-3">
                                                <h3 className="font-bold text-lg">{c.title}</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-6">
                                        <button className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                                            <Icon type="folder" size={18} />Apri Caso
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [selectedCase, setSelectedCase] = useState(null);
            return selectedCase ? <CaseView caseId={selectedCase} onBack={() => setSelectedCase(null)} /> : <CaseSelector onSelectCase={setSelectedCase} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>